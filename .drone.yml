---
kind: pipeline
type: kubernetes
name: repo_build

trigger:
  event:
  - cron
  cron:
  - check_updates
  - full_build

concurrency:
  limit: 1

volumes:
- name: dockersock
  temp: {}

services:
- name: docker_engine
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

steps:
- name: is_update
  image: archlinux
  environment:
    TZ: Europe/Paris
  commands:
    - echo "incremental" > build_options
  when:
    event:
    - cron
    cron:
    - check_updates

- name: is_full_build
  image: archlinux
  environment:
    TZ: Europe/Paris
  commands:
    - echo "full" > build_options
  when:
    event:
    - cron
    cron:
    - full_build

- name: build_repo
  image: archlinux:base
  environment:
    TZ: Europe/Paris
    PGP_KEY:
      from_secret: PGP_KEY
    GIT_TOKEN:
      from_secret: GIT_TOKEN
  volumes:
  - name: dockersock
    path: /var/run
  commands:
    - "[[ -f build_options ]] && export BUILD_OPTIONS=$(cat build_options)"
    - bash ./repo_build.sh "$BUILD_OPTIONS" "$${PGP_KEY}" "$${SSH_KEY}"

- name: commit_packages_update
  image: appleboy/drone-git-push
  settings:
    TZ: Europe/Paris
    ssh_key:
      from_secret: CI_SSH_KEY
    author_name: BotCI
    author_email: bot@ci
    branch: master
    remote: git@github.com:zaggash/archlinux-aur.git
    commit: false
    force: false

- name: notify_updated_packages
  image: docker:dind
  environment:
    webhook_id:
      from_secret: GLOBAL_CI_DISCORD_ID
    webhook_token:
      from_secret: GLOBAL_CI_DISCORD_TOKEN
  volumes:
  - name: dockersock
    path: /var/run
  commands:
    - |
      if [ -f commit_msg ]
      then
        cat commit_msg |\
          docker run -i --rm ghcr.io/hotio/apprise:latest \
           --title "Updated Packages:" \
           "discord://$${webhook_id}/$${webhook_token}?avatar_url=https://github.com/drone/brand/raw/master/logos/png/white/drone-logo-png-white-64.png"
      else
        exit 0
      fi
  when:
    status:
    - success
        
- name: notify_discord
  image: appleboy/drone-discord
  settings:
    webhook_id:
      from_secret: GLOBAL_CI_DISCORD_ID
    webhook_token:
      from_secret: GLOBAL_CI_DISCORD_TOKEN
    message: >
      ❌ Arch Repo build #{{build.number}} of `{{repo.name}}` failed.  
      🌐 {{ build.link }}
  when:
    status:
    - failure
